<div class="container py-4">
  <h3>Carrito</h3>

  <!-- manejamos el async y los estados con ng-template -->
  <ng-container *ngIf="items$ | async as items; else loading">
    <!-- vacío -->
    <div *ngIf="items.length === 0" class="alert alert-info">
      Tu carrito está vacío.
    </div>

    <!-- con items -->
    <ng-container *ngIf="items.length > 0">
      <div class="list-group mb-3">
        <div
          *ngFor="let it of items; trackBy: trackByProduct"
          class="list-group-item d-flex align-items-center gap-3"
        >
          <div style="width:72px; height:72px; background:#f5f5f5; display:flex;align-items:center;justify-content:center;border-radius:6px">
            Img
          </div>

          <div class="flex-grow-1">
            <div class="fw-bold">{{ it.product?.nombre }}</div>
            <div class="text-muted small">
              {{
                it.product?.descripcion
                  ? (it.product.descripcion | slice:0:80) +
                    (it.product.descripcion.length > 80 ? '...' : '')
                  : ''
              }}
            </div>
            <div class="mt-2">
              Precio unitario:
              <strong>
                {{ (it.product?.precio ?? 0) | number:'1.2-2' }}
                {{ it.product?.moneda || '' }}
              </strong>
            </div>
          </div>

          <div style="min-width:140px; text-align:right">
            <div class="input-group mb-2">
              <button
                class="btn btn-outline-secondary"
                (click)="update(getProdId(it), (it.quantity || 1) - 1)"
              >-</button>

              <input
                class="form-control text-center"
                style="width:60px"
                type="number"
                [value]="it.quantity || 1"
                (change)="update(getProdId(it), toNumber($event))"
              />

              <button
                class="btn btn-outline-secondary"
                (click)="update(getProdId(it), (it.quantity || 1) + 1)"
              >+</button>
            </div>

            <div class="text-end">
              <div class="small text-muted">Subtotal</div>
              <div class="fw-bold">
                {{
                  ((it.product?.precio ?? 0) * (it.quantity || 1)) | number:'1.2-2'
                }} {{ it.product?.moneda || '' }}
              </div>
              <button
                class="btn btn-link btn-sm text-danger"
                (click)="remove(getProdId(it))"
              >
                Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- totales fuera de la .list-group -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <button class="btn btn-outline-danger" (click)="clear()">
            Vaciar carrito
          </button>
        </div>

        <div class="text-end">
          <div class="small text-muted">Total</div>
          <div class="h5">
            <span *ngIf="total$ | async as tot">{{ tot | number:'1.2-2' }}</span>
            <small class="text-muted">ARS</small>
          </div>
          <button class="btn btn-primary mt-2">Ir a pagar</button>
        </div>
      </div>
    </ng-container>
  </ng-container>

  <ng-template #loading>
    <div class="text-muted">Cargando carrito...</div>
  </ng-template>
</div>
