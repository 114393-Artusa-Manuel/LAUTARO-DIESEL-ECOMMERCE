<section class="container-fluid py-4 app-home">
  <div class="container-fluid px-4">

    <!-- HERO -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="rounded-4 p-4 p-lg-5 d-flex flex-column flex-lg-row align-items-start align-items-lg-center border"
          style="background:#000; border-color:#111;">
          
          <div class="flex-grow-1 me-lg-5">
            <h1 class="h2 fw-bold mb-2 text-white">
              Repuestos diésel de alto rendimiento
            </h1>
            <p class="mb-3 text-white-50" style="max-width:520px;">
              Inyección, turbos y mantenimiento con envío a todo el país. Calidad profesional para tu motor.
            </p>

            <!-- BUSCADOR -->
            <div class="input-group input-group-lg mb-2">
              <input class="form-control border-0" 
                style="background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.3);"
                placeholder="Buscá por código o producto (ej: 0445110)"
                [(ngModel)]="q">
              <button class="btn fw-semibold text-white" style="background:#e60000;">
                Buscar
              </button>
            </div>

            <!-- Estados -->
            <div *ngIf="loading" class="mt-2 small text-white">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Buscando productos...
            </div>

            <div *ngIf="message" class="alert alert-danger mt-2 py-2 px-3 small mb-0">
              {{ message }}
            </div>

            <!-- FILTROS -->
            <div class="d-flex flex-wrap gap-2 mt-4">
              <button class="btn btn-sm btn-outline-light"
                [class.active]="activeCategory === 'all'"
                (click)="setCategory('all')">
                Todos los productos
              </button>

              @for (c of categorias; track getCategoryKey(c)) {
                <button class="btn btn-sm btn-outline-light"
                  [class.active]="activeCategory === (c.id ?? c.idCategoria ?? c)"
                  (click)="setCategory(c.id ?? c.idCategoria ?? c)">
                  {{ c.nombre ?? c.name ?? c.titulo ?? c.texto ?? c.id }}
                </button>
              }
            </div>
          </div>

          <!-- Imagen / carrusel -->
          <div class="mt-4 mt-lg-0 flex-shrink-0" style="width:320px;">
            <div class="bg-black rounded-4 p-2 border border-dark">
              <div id="homeCarousel" class="carousel slide" data-bs-ride="carousel">
                
                <div class="carousel-indicators">
                  @for (s of carouselSlides; let i = $index; track i) {
                    <button type="button"
                      data-bs-target="#homeCarousel"
                      [attr.data-bs-slide-to]="i"
                      [class.active]="i === 0">
                    </button>
                  }
                </div>

                <div class="carousel-inner rounded-3 overflow-hidden">
                  @for (s of carouselSlides; let i = $index; track i) {
                    <div class="carousel-item" [class.active]="i === 0">
                      <img [src]="getImg(s)" class="d-block w-100" [alt]="getName(s)">
                      <div class="carousel-caption text-start bg-dark bg-opacity-75 rounded-3 p-2">
                        <div class="small text-white">{{ getName(s) }}</div>
                        <div class="fw-bold text-danger">
                          {{ getPrice(s) | currency:'ARS':'symbol-narrow':'1.0-0':'es-AR' }}
                        </div>
                      </div>
                    </div>
                  }
                </div>

              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- DESTACADOS (products-area) -->
    <div class="products-area mb-4 py-4">
    

    <!-- DESTACADOS -->
    <div class="mb-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="h5 fw-bold text-black">Destacados</h2>
        <a routerLink="/productos" class="small text-danger text-decoration-none">Ver más</a>
      </div>

      <div class="row g-3">
        @for (p of filteredProducts; let i = $index; track getId(p,i)) {
          <div class="col-6 col-md-4 col-lg-3">
            <div class="card h-100 product-card position-relative">

              <div class="position-absolute" style="z-index:5; right:0;">
                <span *ngIf="p?.descuento && p.descuento > 0" class="badge bg-danger m-2">-{{ p.descuento }}%</span>
                <span *ngIf="!p?.stock || p?.stock <= 0" class="badge bg-secondary m-2">Sin stock</span>
              </div>

              <div class="card-img-top placeholder-img bg-light d-flex align-items-center justify-content-center position-relative" style="min-height:200px; overflow:hidden;">
                <img [src]="getImg(p)" [alt]="getName(p)" class="img-fluid w-100 h-100" style="object-fit:cover;" />
              </div>

              <div class="card-body d-flex flex-column p-2">
                <h5 class="card-title small mb-1">{{ getName(p) }}</h5>

                <p class="card-text text-muted small mb-2" style="min-height:2.2em;">
                  {{ (p.descripcion || '') | slice:0:80 }}{{ (p.descripcion && p.descripcion.length > 80) ? '...' : '' }}
                </p>

                <div class="mb-2">
                  <div *ngIf="p?.descuento && p.descuento > 0">
                    <span class="text-decoration-line-through text-muted me-1">{{ (p.precio || getPrice(p)) | currency:'ARS':'symbol-narrow':'1.2-2':'es-AR' }}</span>
                    <strong class="text-success">{{ ( (p.precio || getPrice(p)) * (1 - (p.descuento/100)) ) | currency:'ARS':'symbol-narrow':'1.0-0':'es-AR' }}</strong>
                  </div>
                  <div *ngIf="!p?.descuento || p?.descuento === 0">
                    <strong>{{ getPrice(p) | currency:'ARS':'symbol-narrow':'1.0-0':'es-AR' }}</strong>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-1 mb-2">
                  <span *ngFor="let m of (p.marcas || p.marcasIds || [])" class="badge bg-secondary small">{{ m?.nombre ?? m }}</span>
                  <span *ngFor="let c of (p.categorias || p.categoriasIds || [])" class="badge bg-info text-dark small">{{ c?.nombre ?? c }}</span>
                </div>

                <div class="mt-auto d-flex gap-2">
                  <a *ngIf="hasProductId(p)" class="btn btn-sm btn-danger text-white flex-grow-1" [routerLink]="['/productos', getProductId(p)]">Ver</a>
                  <button *ngIf="!hasProductId(p)" class="btn btn-sm btn-danger text-white flex-grow-1" disabled>Ver</button>
                  <button class="btn btn-sm btn-dark text-white flex-grow-1" (click)="addToCart(p)" [disabled]="p?.stock === 0">Comprar</button>
                </div>
              </div>
            </div>
          </div>
        }

        @if (!filteredProducts.length) {
          <div class="col-12">
            <div class="text-muted small">No hay productos para la búsqueda/filtrado.</div>
          </div>
        }
      </div>
    </div>

    </div> <!-- end products-area -->

    <!-- CATEGORÍAS DESTACADAS (4) -->
    <div class="mb-5">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="h5 fw-bold text-black">Categorías destacadas</h2>
        <a routerLink="/productos" class="small text-danger text-decoration-none">Ver todo</a>
      </div>

      <div class="row g-3">
        @for (c of categorias.slice(0,4); track getCategoryKey(c)) {
          <div class="col-12">
            <div class="category-block p-3 mb-3 rounded-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="h6 mb-0">{{ c.nombre ?? c.name ?? c.titulo ?? c.texto ?? c.id }}</div>
                <a [routerLink]="['/productos']" class="small text-danger text-decoration-none">Ver todos</a>
              </div>

              <div class="row g-3">
                @for (p of categoryProducts[getCategoryKey(c)] || []; let i = $index; track getId(p,i)) {
                  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card product-card h-100 border-0 shadow-sm rounded-3">
                      <div class="position-relative">
                        <img [src]="getImg(p)" class="card-img-top" style="object-fit:cover;height:190px;">
                        @if (p.badge) {
                          <span class="badge bg-warning text-dark position-absolute m-2">{{ p.badge }}</span>
                        }
                      </div>

                      <div class="card-body p-2 d-flex flex-column">
                        <div class="small mb-1" style="min-height:2.5em;">
                          {{ getName(p) }}
                        </div>
                        <div class="mt-auto">
                          <div class="fw-bold fs-5 text-danger">
                            {{ getPrice(p) | currency:'ARS':'symbol-narrow':'1.0-0':'es-AR' }}
                          </div>
                          <a *ngIf="hasProductId(p)" [routerLink]="['/productos', getProductId(p)]" class="btn btn-sm btn-danger text-white w-100 mt-2 mb-2">Ver</a>
                          <button *ngIf="!hasProductId(p)" class="btn btn-sm btn-danger text-white w-100 mt-2 mb-2" disabled>Ver</button>
                          <button class="btn btn-sm btn-dark text-white w-100" (click)="addToCart(p)">Agregar</button>
                        </div>
                      </div>
                    </div>
                  </div>
                }
                @if (!(categoryProducts[getCategoryKey(c)]?.length)) {
                  <div class="col-12"><div class="text-muted small">No hay productos</div></div>
                }
              </div>

            </div>
          </div>
        }
      </div>
    </div>

    

    <!-- CTA -->
    <div class="py-5 text-center bg-black text-white rounded-4">
      <h3 class="mb-2">¿Necesitás asesoramiento técnico?</h3>
      <p class="text-white-50 mb-4">Enviá tu consulta con número de chasis o foto real de la pieza.</p>
      <a routerLink="/contacto" class="btn text-white px-4 py-2" style="background:#e60000;">
        Contactar ahora
      </a>
    </div>

  </div>
</section>
