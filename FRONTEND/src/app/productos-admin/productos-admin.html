<div class="container py-4">
  <h4>Crear producto</h4>

  <div *ngIf="message" class="alert alert-info">{{ message }}</div>

  <!-- Products list -->
  <div class="mb-4">
    <h5 class="d-flex align-items-center justify-content-between">
      <span>Productos</span>
      <div class="d-flex gap-2">
        <button
          class="btn btn-sm btn-outline-secondary"
          type="button"
          (click)="openManageModal('marcas')"
        >
          Gestionar marcas/categor√≠as
        </button>
        <button class="btn btn-sm btn-primary" type="button" (click)="toggleCreate()">
          {{ showCreate ? 'Cerrar formulario' : 'Nuevo producto' }}
        </button>
      </div>
    </h5>
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Slug</th>
          <th>Activo</th>
          <th>Marcas</th>
          <th>Categor√≠as</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of products">
          <td>{{ p.idProducto ?? p.id }}</td>
          <td>{{ p.nombre }}</td>
          <td>{{ p.slug }}</td>
          <td>{{ p.activo ? 'S√≠' : 'No' }}</td>
          <td style="max-width: 220px; white-space: normal">{{ getMarcaNames(p) || '-' }}</td>
          <td style="max-width: 220px; white-space: normal">{{ getCategoriaNames(p) || '-' }}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-2" type="button" (click)="edit(p)">
              Editar
            </button>
            <button class="btn btn-sm btn-outline-danger" type="button" (click)="delete(p)">
              Eliminar
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Inline edit panel -->
  <!-- (omitido para ahorrar espacio, no lo modificamos) -->
  <!-- üîπ PANEL DE EDICI√ìN DE PRODUCTO -->
  <div *ngIf="editModel" class="card p-3 mb-4 shadow-sm">
    <h5>Editar producto: {{ editModel.nombre }}</h5>

    <form (ngSubmit)="saveEdit()">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Nombre</label>
          <input class="form-control" [(ngModel)]="editModel.nombre" name="editNombre" required />
        </div>

        <div class="col-md-6 mb-3">
          <label class="form-label">Slug</label>
          <input class="form-control" [(ngModel)]="editModel.slug" name="editSlug" required />
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Descripci√≥n</label>
        <textarea
          class="form-control"
          [(ngModel)]="editModel.descripcion"
          name="editDescripcion"
        ></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Precio</label>
        <input
          type="number"
          step="0.01"
          class="form-control"
          [(ngModel)]="editModel.precio"
          name="editPrecio"
        />
      </div>

      <!-- üî∏ Campo de stock editable -->
      <div class="mb-3">
        <label class="form-label">Stock</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="editModel.stock"
          name="editStock"
          min="0"
        />
      </div>

      <div class="form-check mb-3">
        <input
          class="form-check-input"
          type="checkbox"
          [(ngModel)]="editModel.activo"
          name="editActivo"
          id="editActivo"
        />
        <label class="form-check-label" for="editActivo">Activo</label>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary" [disabled]="loading">Guardar</button>
        <button type="button" class="btn btn-outline-secondary" (click)="cancelEdit()">
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <div *ngIf="showCreate">
    <form (ngSubmit)="create()">
      <div class="mb-3">
        <label class="form-label">Nombre</label>
        <input class="form-control" [(ngModel)]="model.nombre" name="nombre" required />
      </div>

      <div class="mb-3">
        <label class="form-label">Slug (√∫nico)</label>
        <input class="form-control" [(ngModel)]="model.slug" name="slug" required />
      </div>

      <div class="mb-3">
        <label class="form-label">Descripci√≥n</label>
        <textarea
          class="form-control"
          [(ngModel)]="model.descripcion"
          name="descripcion"
        ></textarea>
      </div>

      <div class="mb-3 form-check">
        <input
          class="form-check-input"
          type="checkbox"
          [(ngModel)]="model.activo"
          name="activo"
          id="activo"
        />
        <label class="form-check-label" for="activo">Activo</label>
      </div>

      <div class="mb-3">
        <label class="form-label">Marcas</label>
        <div class="d-flex gap-2 mb-1">
          <input
            class="form-control form-control-sm"
            placeholder="Buscar marcas..."
            [(ngModel)]="marcaFilter"
            (ngModelChange)="onMarcaFilterChange()"
            name="createMarcaSearch"
          />
          <input
            class="form-control form-control-sm"
            placeholder="Nueva marca..."
            [(ngModel)]="newMarcaName"
            name="createNewMarca"
          />
          <button class="btn btn-sm btn-primary" type="button" (click)="createMarca()">
            Crear
          </button>
        </div>
        <div class="row row-cols-2 row-cols-md-3 g-1 entity-grid">
          <div *ngFor="let m of filteredMarcas" class="col">
            <div
              class="form-check entity-item"
              [class.checked]="isMarcaChecked(m.idMarca ?? m.id, false)"
            >
              <input
                class="form-check-input"
                type="checkbox"
                [id]="'create-marca-' + (m.idMarca ?? m.id)"
                [checked]="isMarcaChecked(m.idMarca ?? m.id, false)"
                (change)="toggleMarcaSelection(m.idMarca ?? m.id, $event.target.checked, false)"
              />
              <label
                class="form-check-label entity-label"
                [for]="'create-marca-' + (m.idMarca ?? m.id)"
                >{{ m.nombre }}</label
              >
            </div>
          </div>
        </div>
      </div>

      <!-- üîπ Fila de precio, moneda y stock -->
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Precio</label>
          <input
            class="form-control"
            type="number"
            step="0.01"
            [(ngModel)]="model.precio"
            name="precio"
          />
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Moneda</label>
          <input class="form-control" [(ngModel)]="model.moneda" name="moneda" />
        </div>
        <!-- üî∏ Nuevo campo STOCK -->
        <div class="col-md-4 mb-3">
          <label class="form-label">Stock</label>
          <input
            class="form-control"
            type="number"
            min="0"
            [(ngModel)]="model.stock"
            name="stock"
            required
          />
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Categor√≠as</label>
        <div class="d-flex gap-2 mb-1">
          <input
            class="form-control form-control-sm"
            placeholder="Buscar categor√≠as..."
            [(ngModel)]="categoriaFilter"
            (ngModelChange)="onCategoriaFilterChange()"
            name="createCategoriaSearch"
          />
          <input
            class="form-control form-control-sm"
            placeholder="Nueva categor√≠a..."
            [(ngModel)]="newCategoriaName"
            name="createNewCategoria2"
          />
          <button class="btn btn-sm btn-primary" type="button" (click)="createCategoria()">
            Crear
          </button>
        </div>
        <div class="row row-cols-2 row-cols-md-3 g-1 entity-grid">
          <div *ngFor="let c of filteredCategorias" class="col">
            <div
              class="form-check entity-item"
              [class.checked]="isCategoriaChecked(c.idCategoria ?? c.id, false)"
            >
              <input
                class="form-check-input"
                type="checkbox"
                [id]="'create-cat-' + (c.idCategoria ?? c.id)"
                [checked]="isCategoriaChecked(c.idCategoria ?? c.id, false)"
                (change)="
                  toggleCategoriaSelection(c.idCategoria ?? c.id, $event.target.checked, false)
                "
              />
              <label
                class="form-check-label entity-label"
                [for]="'create-cat-' + (c.idCategoria ?? c.id)"
                >{{ c.nombre }}</label
              >
            </div>
          </div>
        </div>
      </div>

      <button class="btn btn-primary" type="submit" [disabled]="loading">Crear</button>
      <button
        class="btn btn-secondary ms-2"
        type="button"
        (click)="createMinimal()"
        [disabled]="loading"
      >
        Probar sin asociaciones
      </button>
      <button class="btn btn-outline-secondary ms-2" type="button" (click)="toggleCreate()">
        Cancelar
      </button>
    </form>
  </div>
</div>
